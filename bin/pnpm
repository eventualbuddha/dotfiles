#!/bin/sh

## Try to run pnpm via locally installed package
dir="${PWD}"
cli="$(basename $0)"
pkg=pnpm

while [ "${dir}" != "/" ]; do
  package_json_path=$(cd "${dir}" && ~/bin/find-up package.json)

  if [ -f "${package_json_path}" ]; then
    version=$(~/bin/json-get "devDependencies.${pkg}" < "${package_json_path}")

    if [ -n "${version}" ]; then
      node_modules_path=$(cd $(dirname "${package_json_path}") && ~/bin/find-up node_modules)
      bin_path=${node_modules_path}/.bin/${cli}

      if [ ! -x "${bin_path}" ]; then
        echo "warning: expected ${pkg}@${version} at ${bin_path}, falling back" >&2
        break
      fi

      exec "${bin_path}" "$@"
    fi
  fi

  dir="$(dirname "${dir}")"
done

## Otherwise, run pnpm via node.
exec ~/bin/run-bin-with-version-file node .node-version NODE_VERSION "${cli}" -- "$@"
